# **ğŸ§© CRUD Operations with Mongoose**

## **ğŸ¯ Goal**

A TypeScript rewrite of the previous MongoDB Shell exercise using Mongoose, with basic schemas and type-safe file organization.

### **Why Mongoose?**

MongoDB Shell is useful for quick testing, but lacks structure, validation, and reusability. Mongoose gives us:

- **Schemas**Â for consistent data shape
- **Type safety**Â with TypeScript
- **Validation and defaults**
- **Auto timestamps**Â (`createdAt`,Â `updatedAt`)
- **Better maintainability**Â in applications

### **Folder Structure**

```bash
ğŸ“ project-root
â”œâ”€â”€ .env
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ ğŸ“ src
    â”œâ”€â”€ ğŸ“„ db.ts                # MongoDB connection logic
    â”œâ”€â”€ ğŸ“ models
    â”‚   â””â”€â”€ ğŸ“„ Products.ts      # Mongoose model definition
		â”‚   â””â”€â”€ ğŸ“„ index.ts         # Barrel file for clean imports
    â”œâ”€â”€ ğŸ“ controllers
    â”‚   â”œâ”€â”€ ğŸ“„ create.ts        # Create documents (insertOne, insertMany)
    â”‚   â”œâ”€â”€ ğŸ“„ read.ts          # Read documents (find)
    â”‚   â”œâ”€â”€ ğŸ“„ update.ts        # Update documents (updateOne, updateMany)
    â”‚   â””â”€â”€ ğŸ“„ delete.ts        # Delete documents (deleteOne, deleteMany)
```

## **Setup**

### **Required NPM Packages**

```bash
npm install mongoose                   # â†’ âœ… required at runtime
npm install -D typescript @types/node  # â†’ ğŸ› ï¸ used during development
```

### **`.env`**

```bash
MONGO_URI=mongodb+srv://your_username:your_password@your_cluster.mongodb.net
```

ğŸ’¡ for full setup instructions, revisit: [Running TypeScript in Node](https://www.notion.so/Running-TS-in-Node-21dae18bcb548013a47ef10717d063d0?pvs=21)

### **`package.json`Â Scripts**

```json
"scripts": {
  "type-check": "tsc",
  "create": "node --experimental-transform-types --disable-warning=ExperimentalWarning --env-file=.env src/controllers/create.ts",
  "read": "node --experimental-transform-types --disable-warning=ExperimentalWarning --env-file=.env src/controllers/read.ts",
  "update": "node --experimental-transform-types --disable-warning=ExperimentalWarning --env-file=.env src/controllers/update.ts",
  "delete": "node --experimental-transform-types --disable-warning=ExperimentalWarning --env-file=.env src/controllers/delete.ts"
}
```

### **`src/db.ts`**

Establishes a connection to MongoDB using the URI from `.env`. Should be imported first in every controller to ensure DB is connected before queries.

```tsx
import mongoose from 'mongoose';
const MONGO_URI = process.env.MONGO_URI || '';

try {
  await mongoose.connect(MONGO_URI);
  console.log('âœ… Connected to MongoDB');
} catch (err) {
  console.error('âŒ MongoDB connection error:', err);
  process.exit(1);
}
```

### **`src/models/Products.ts`**

Defines a `Product` model using `mongoose.Schema`, with validation rules and timestamps. Only `createdAt` is enabled in this case.

```tsx
import { Schema, model } from 'mongoose';

const productSchema = new Schema(
  {
    name: { type: String, required: true, unique: true },
    stock: { type: Number, required: true },
    price: { type: Number, required: true },
    tags: [{ type: String }],
  },
  {
    timestamps: { createdAt: true, updatedAt: false },
  }
);

const Product = model('Product', productSchema);
export default Product;
```

Importing Models from `index.ts`

to simplify and organise imports, we use an **`index.ts` barrel file** inside the models folder:

### **`src/models/index.ts`**

```tsx
export { default as Product } from './Products.ts';
```

This is a **barrel file**, which lets you import models more cleanly:

```tsx
// Instead of:

import Product from '#/models/Products.ts';

// You can simply write:

import { Product } from '#/models';
```

### **`src/controllers/create.ts`**

```tsx
import '#db';
import { Product } from '#models';

await Product.create({
  name: 'T-Shirt',
  price: 19.99,
  stock: 50,
  tags: ['clothing', 'unisex'],
});

await Product.insertMany([
  { name: 'Hoodie', price: 34.99, stock: 30, tags: ['clothing', 'winter'] },
  { name: 'Sneakers', price: 59.99, stock: 20, tags: ['shoes', 'sport'] },
  { name: 'Cap', price: 14.99, stock: 100, tags: ['accessory', 'summer'] },
]);

console.log('âœ… added Products into Database');
process.exit();
```

### **`src/controllers/read.ts`**

```tsx
import '#db';
import { Product } from '#models';

console.log('ğŸ“¦ All products:\n', await Product.find());

console.log(
  "ğŸ§¢ Products with 'clothing' tag:\n",
  await Product.find({ tags: 'clothing' })
);

console.log(
  'ğŸ“ˆ In-stock products:\n',
  await Product.find({ stock: { $gt: 0 } })
);

console.log(
  'ğŸ’° Within price range $10 - $30:\n',
  await Product.find({ price: { $gte: 10, $lte: 30 } })
);

process.exit();
```

### **`src/controllers/update.ts`**

```tsx
import '#db';
import { Product } from '#models';

await Product.updateOne({ name: 'T-Shirt' }, { $set: { stock: 45 } });
console.log('ğŸ”„ T-Shirt stock updated');

await Product.updateMany({ tags: 'clothing' }, { $addToSet: { tags: 'sale' } });
console.log('ğŸ·ï¸  Added "sale" tag to all clothing items');

process.exit();
```

### **`src/controllers/delete.ts`**

```tsx
import '#db';
import { Product } from '#models';

// Delete specific product by name
await Product.deleteOne({ name: 'Cap' });
console.log('ğŸ—‘ï¸  Deleted product: Cap');

// Delete all out-of-stock products
await Product.deleteMany({ stock: { $lte: 0 } });
console.log('ğŸ§¹ Deleted all out-of-stock products');

// Optionally, delete all products
// await Product.deleteMany({});
// console.log('ğŸ§¹ All products deleted');

process.exit();
```

## **Example Usage**

```bash
npm run create     # â• Insert sample products into the database
npm run read       # ğŸ” Query products (by tag, stock, or price range)
npm run update     # ğŸ”„ Update product stock or tags
npm run delete     # ğŸ—‘ï¸ Delete specific or all products
```

## **Outcome**

- Learn how toÂ **migrate MongoDB Shell logic into an actual Node.js project**
  - UnderstandÂ **schema-based development**Â using Mongoose
  - Practice CRUD operations
